---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: virt-sysprep-updater
spec:
  tasks:
    - name: create-datavolume-from-manifest
      params:
        - name: manifest
          value: |
            apiVersion: cdi.kubevirt.io/v1beta1
            kind: DataVolume
            metadata:
              generateName: virt-sysprep-updated-vm-base-
            spec:
              pvc:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
                volumeMode: Filesystem
              source:
                http:
                  url: https://download.fedoraproject.org/pub/fedora/linux/releases/33/Cloud/x86_64/images/Fedora-Cloud-Base-33-1.2.x86_64.raw.xz
        - name: waitForSuccess
          value: 'true'
      taskRef:
        kind: ClusterTask
        name: create-datavolume-from-manifest
    - name: disk-virt-sysprep
      params:
        - name: pvc
          value: "$(tasks.create-datavolume-from-manifest.results.name)"
        - name: sysprepCommands
          value: |
            run-command yum update -y
        - name: additionalOptions
          value: "--network"
      taskRef:
        kind: ClusterTask
        name: disk-virt-sysprep
      runAfter:
        - create-datavolume-from-manifest
    - name: create-vm-from-manifest
      params:
        - name: manifest
          value: |
            apiVersion: kubevirt.io/v1alpha3
            kind: VirtualMachine
            metadata:
              generateName: virt-sysprep-updated-vm-
              annotation:
                description: Fedora VM generated by server-deployer pipeline
              labels:
                app: virt-sysprep-updated-vm
            spec:
              running: false
              template:
                metadata:
                  labels:
                    kubevirt.io/domain: virt-sysprep-updated-vm
                spec:
                  domain:
                    cpu:
                      cores: 2
                      sockets: 1
                      threads: 1
                    devices:
                      disks:
                        - name: cloudinitdrive
                          disk:
                            bus: virtio
                      interfaces:
                        - masquerade: {}
                          name: default
                      networkInterfaceMultiqueue: true
                      rng: {}
                    resources:
                      requests:
                        memory: 2Gi
                  hostname: virt-sysprep-updated-vm
                  networks:
                    - name: default
                      pod: {}
                  volumes:
                    - name: cloudinitdrive
                      cloudInitConfigDrive:
                        userData: |
                          #cloud-config
                          password: fedora
                          chpasswd: { expire: False }
        - name: ownDataVolumes
          value:
            - "$(tasks.create-datavolume-from-manifest.results.name)"
      runAfter:
        - disk-virt-sysprep
      taskRef:
        kind: ClusterTask
        name: create-vm-from-manifest
